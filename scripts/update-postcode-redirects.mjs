import fs from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const rootDir = path.resolve(__dirname, "..");
const reportsDir = path.join(rootDir, "reports");
const manifestPath = path.join(reportsDir, "postcodes-to-remove.json");
const redirectsPath = path.join(rootDir, "_redirects");

const START = "# --- POSTCODE REDIRECTS START (autogenerated) ---";
const END = "# --- POSTCODE REDIRECTS END (autogenerated) ---";
const targetPath = "/emergency-plumber-bristol/";

const manifestFile = await fs.readFile(manifestPath, "utf8");
const { urls } = JSON.parse(manifestFile);

if (!Array.isArray(urls)) {
  throw new Error("postcodes-to-remove.json must include a urls array.");
}

const redirects = urls.map((url) => {
  const { pathname } = new URL(url);
  const source = pathname.endsWith("/") ? pathname.slice(0, -1) : pathname;
  return `${source}  ${targetPath}  301`;
});

const existing = await fs
  .readFile(redirectsPath, "utf8")
  .catch(() => "# Cloudflare Pages redirects");

const lines = existing.split(/\r?\n/);
const startIndex = lines.indexOf(START);
const endIndex = lines.indexOf(END);
let nextLines = [];

if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {
  nextLines = [
    ...lines.slice(0, startIndex),
    START,
    ...redirects,
    END,
    ...lines.slice(endIndex + 1),
  ];
} else {
  nextLines = [...lines.filter(Boolean), START, ...redirects, END];
}

await fs.writeFile(redirectsPath, `${nextLines.join("\n")}\n`);
console.log(`Updated ${redirectsPath} with ${redirects.length} postcode redirects.`);
